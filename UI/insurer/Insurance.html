<!DOCTYPE html>
<html>
<head>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body {
  font-family: "MerriweatherLight Regular";
  transition: background-color .5s;
  margin-left: 2%;
  margin-right: 2%;
  background-image: url("/images/Fellows-Watch-Auction-11.jpg");
  background-repeat: no-repeat;
  background-size: auto;
}
#main {
  transition: margin-left .5s;
  padding: 20px;
}
@media screen and (max-height: 450px) {
  .sidenav {padding-top: 15px;}
  .sidenav a {font-size: 18px;}
}
.modal {
  display: none; /* Hidden by default */
  position: fixed; /* Stay in place */
  z-index: 1; /* Sit on top */
  padding-top: 100px; /* Location of the box */
  left: 0;
  top: 0;
  width: 100%; /* Full width */
  height: 100%; /* Full height */
  overflow: auto; /* Enable scroll if needed */
  background-color: rgb(0, 0, 0); /* Fallback color */
  background-color: rgba(0, 0, 0, 0.4); /* Black w/ opacity */
  
}
/* Modal Content */
.modal-content {
  background-color: #fefefe;
  margin: auto;
  padding: 40px;
  padding-top: 30px;
  border: 1px solid #888;
  width: 80%;
}
/* The Close Button */
.close {
  color: black;
  float: right;
  font-size: 28px;
  font-weight: bold;
}
.close:hover,
.close:focus {
  color:red;
  text-decoration: none;
  cursor: pointer;
}
table, th, td {
  text-align: center;
  font-family: "MerriweatherLight Regular";
  font-size: 15px;
  color:rgb(0, 0, 0);
}
hr { 
  display: block;
  margin-top: 0.5em;
  margin-bottom: 0.5em;
  width: 50;
  margin-left: auto;
  margin-right: auto;
  border-style: inset;
  border-width: 1px;
}

.span1{
  position: absolute;
  left: 175px;
  top: 500px;
  text-align: center;
  font-family: "MerriweatherLight Regular";
  font-size: 15px;
}
</style>
</head>
<body style="background-color:rgb(225, 235, 236);">
        <div id="main">
                <ul class="nav navbar-nav navbar-right">
                    <li><a href="/"><span style="font-size:15px;color:maroon" class="glyphicon glyphicon-home"> Insurance Provider</span></a></li>
                </ul>
                <span style="font-size:30px;color:maroon;cursor:pointer" ><img src="/images/rolex-logo.png" height="35" width="40"></span>
        </div>
        <span class="span1"><p>Wear your watches with pride
            As part of your lifestyle, watches are meant to be worn and enjoyed.<br>
            Insurers actually like you to wear your watches, instead of keeping them squirrelled away.<br>
            Underwriters like watch collections to be spread between wrists, displays and safes so they aren’t together if the worst happens.<br>
            ‘If watch collections are dispersed,’ says Jones-Walker, ‘premiums are often less, and security requirements more relaxed, than if everything’s kept together.’</p>
       <h3> <button id="myBtn">Verify Watch Authenticity for Insurance</button></h3></span>
    <div id="myModal" class="modal">
            <div class="modal-content">
              <span class="close">&times;</span>
              <h3 font-family="sans-serif" color="maroon">Watch History</h3>
              <div class="row">
                Enter serial number: <input type="text" placeholder="Enter Serial Number" id="serial" style="width: 350px;" />
                <button id="viewbutton" type="submit" onclick="ShowHideDiv()">View History</button> <br><br>
              </div>

              <div id="viewdiv" class="modal-content" style="display: none">
                <div class="row">
                <img src="/images/rolex-watch-img.jpg" height="150" width="120">
                </div>
                <hr />
                <div class="row">
                          <table style="width:100%" id="details-tbl">
                           <thead>
                               <th>Serial No</th>
                               <th>Batch Id</th>
                               <th>Model No</th>
                               <th>Model Name</th>
                               <th>Date of Manufacture</th>
                               <th>Certificate ID</th>
                               <th>Price</th>
                           </thead>
                           <tbody>

                           </tbody>
                           </table>
                </div>
                    <hr />
              
              
              <div class="row">
                  <h4>Ownership History</h4>
                  <table style="width:100%" id="owner-tbl">
                     <thead>
                         <tr>
                        <th>Owner</th>
                        <th>Date of procurement</th>
                        <th>Service Id</th>
                        <th>Insurance Id</th>
                        <th>TraxId</th>
                      </tr>
                    </thead>
                    <tbody>
                      
                    </tbody>
                  </table>
                <hr />
              </div>
              <div class="row">
                    <h4>Service History</h4>
                    <table style="width:100%" id="service-tbl">
                     <thead>
                        <tr>
                            <th>Service ID</th>
                            <th>Service Centre</th>
                            <th>Service Date</th>
                            <th>Service Details</th>
                            <th>TraxId</th>
                        </tr>
                    </thead>
                        <tbody>
                        
                        </tbody>
                    </table>
                  <hr />
                </div>
                <div class="row">
                <h4>Insurance History</h4>
                    <table style="width:100%" id="insurance-tbl">
                       <thead> <tr>
                          <th>Insurance Id</th>
                          <th>Insurer</th>
                          <th>Insurance expires on</th>  
                          <th>TraxId</th>
                        </tr>
                        </thead>
                        <tbody>
                        
                        </tbody>
                    </table>
                <hr />
                </div>
                </div>
                <br>
                <span font-family="MerriweatherLight" font-size=12px class="glyphicon glyphicon-copyright-mark"> 2019 Roles. All rights reserved. <a href="#">Terms of Use.</a> <a href="#"> Privacy Policy</a></span>
    </div>
    </div>
    </div>

<script>
        // Get the modal
        var modal = document.getElementById('myModal');

        // Get the button that opens the modal
        var btn = document.getElementById("myBtn");

        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];

        // When the user clicks the button, open the modal 
        btn.onclick = function() {
          modal.style.display = "block";
          

        }

        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
          modal.style.display = "none";
          document.getElementById("viewdiv").style.display = "none";
        }

        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
          if (event.target == modal) {
            modal.style.display = "none";
          }
        }
          
  </script>

<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
<script src="js/jquery.min.js"></script>
<script src="https://code.jquery.com/jquery-1.12.4.js"></script>

<script src="https://cdn.datatables.net/1.10.16/js/jquery.dataTables.min.js">
</script>

<script src="https://cdn.datatables.net/1.10.16/js/dataTables.jqueryui.min.js"></script>
<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="js/bootstrap.min.js"></script>

<script>

var token="";
function ShowHideDiv(){
    var serialNoVal = $("#serial")[0].value;
    console.log('serialNoVal'+ serialNoVal);
   $(document).ready(function() {
      
 function LoadData(){
    console.log('serialNoVal'+ serialNoVal);
   $.ajax( {
     url: 'http://localhost:4000/channels/mychannel/chaincodes/mycc?peer=peer0.org1.rolex.com&fcn=getproducthistory&args=%5B%22' + serialNoVal+ '%22%5D',
     type: 'GET',
     dataType: 'json',
     data: { },
     beforeSend : function( xhr ) {
         xhr.setRequestHeader( 'Authorization', 'Bearer ' + token );
     },
     success: function( response ) {
       var trHTML = '';
       var trHTMLOwner = '';
       var trHTMLService = '';
       var trHTMLInsurance = '';

       debugger;
       console.log(response);
        debugger;
       $.each(response, function (i, item) {
        var str = item.TxId;
        str = str.slice(0,15);
        if (i == 0) {
               var y = 1;
        }
        if (y == 1){
        trHTML += '<tr><td>' + item.Value.serialNo +
              '</td><td>' + item.Value.batchId +
              '</td><td>' + item.Value.modelNo +
              '</td><td>' + item.Value.modelName +
              '</td><td>' + item.Value.date +
              '</td><td>' + item.Value.cftId +
              '</td><td>' + item.Value.price +
              '</td></tr>';

        trHTMLOwner += '<tr><td>' + item.Value.ownership +
            '</td><td>' + item.Value.date +
            '</td><td>' + item.Value.serviceId +
            '</td><td>' + item.Value.insuranceId +
              '</td><td>' + str + 
            '...</td></tr>';

        if(item.Value.serviceId != "--" ){
        trHTMLService += '<tr><td>' + item.Value.serviceId +
               '</td><td>' + item.Value.serCentre +
               '</td><td>' + item.Value.dateOfService +
               '</td><td>' + item.Value.serviceDetails +
                '</td><td>' + str + 
            '...</td></tr>';
        }
        if((item.Value.insurance != "--") && (item[i].Value.insuranceId != item[i-1].Value.insuranceId)){
        trHTMLInsurance += '<tr><td>'  + item.Value.insuranceId +
            '</td><td>' + item.Value.insurance +
             '</td><td>' + item.Value.insuranceExpiry +
              '</td><td>' + str + 
            '...</td></tr>';
        } 
        }
          else {

              trHTMLOwner += '<tr><td>' + item.Value.ownership +
                  '</td><td>' + item.Value.date +
                  '</td><td>' + item.Value.serviceId +
                  '</td><td>' + item.Value.insuranceId +
                    '</td><td>' + str + 
            '...</td></tr>';

              if(item.Value.serviceId != "--" ){
              trHTMLService += '<tr><td>' + item.Value.serviceId +
                    '</td><td>' + item.Value.serCentre +
                    '</td><td>' + item.Value.dateOfService +
                    '</td><td>' + item.Value.serviceDetails +
                      '</td><td>' + str + 
            '...</td></tr>';
                  }
                  
                  if((item.Value.insurance != "--") && (item[i].Value.insuranceId != item[i-1].Value.insuranceId)){
              trHTMLInsurance += '<tr><td>' + item.Value.insuranceId +
                  '</td><td>' + item.Value.insurance +
                  '</td><td>' + item.Value.insuranceExpiry +
                    '</td><td>' + str + 
            '...</td></tr>';
                  }   
            }     
  });
  
        $('#details-tbl > tbody').empty();
        $('#details-tbl > tbody').append(trHTML);
         $('#owner-tbl > tbody').empty();
         $('#owner-tbl > tbody').append(trHTMLOwner);
         $('#service-tbl > tbody').empty();
         $('#service-tbl > tbody').append(trHTMLService);
         $('#insurance-tbl > tbody').empty();
         $('#insurance-tbl > tbody').append(trHTMLInsurance);
          
        var viewdivision = document.getElementById("viewdiv");
        viewdivision.style.display =  "block";
     },
     error: function (xhr, ajaxOptions, thrownError) {
        alert(xhr.status);
        //alert(message);
        alert(thrownError);
        }
 } )};

 function GenerateToken(){
     $.ajax({
         url: "http://localhost:4000/users",
         type: "POST",
         dataType: "json", // expected format for response
         contentType: "application/x-www-form-urlencoded", // send as JSON
         data: {username:"Jim", orgName:"Org1"},

         success: function(data) {
           //called when successful
           //alert(data.token);
           token=data.token;
           $("#details-tbl > tbody").empty();
           $("#owners-tbl > tbody").empty();
           $("#service-tbl > tbody").empty();
           $("#insurance-tbl > tbody").empty();
           LoadData();
        },

         error: function() {
           //called when there is an error
           alert('Please Refresh Application');
         },
       });
   }

 GenerateToken();
 

 function PopulateTable(){
   
 }
 
 function addProduct(){
   debugger;
   alert('call');
 }

 $('.genToken').click(function(){ 
       GenerateToken();
 });
 $('.loadData').click(function(){ 
       LoadData();
 });
 $('#details-tbl,#service-tbl,#owner-tbl,#insurance-tbl').dataTable({
              "paging": false,
              "searching": false,
              "bLengthChange": false,
              "bFilter": false,
              "bInfo": false,
              "bAutoWidth": false,
              "destory": true
      });
  
  var q = $('#details-tbl').DataTable();
  var p = $('#owner-tbl').DataTable();
  var s = $('#service-tbl').DataTable();
  var v = $('#insurance-tbl').DataTable();

});
}
</script>
</body>
</html>